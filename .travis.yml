language: generic
sudo: false
dist: trusty

cache:
  apt: true
  directories:
    - $HOME/usr/
    - build/resources

addons:
  apt: &apt_base
    sources: &sources_base
      - ubuntu-toolchain-r-test
    packages: &packages_base
      - g++-6
      - libcln-dev
      - libgmp-dev
      - libgtest-dev
      - openjdk-7-jdk
      - time
      - uuid-dev

matrix:
  include:
    - stage: dependencies
      os: linux
      compiler: g++-5
      env: CC=gcc-5 CXX=g++-5
      script: TASK=dependencies MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, g++-5]
    - stage: dependencies
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6
      script: TASK=dependencies MAKE_PARALLEL=-j1 source .ci/build.sh
    - stage: dependencies
      os: linux
      compiler: g++-7
      env: CC=gcc-7 CXX=g++-7
      script: TASK=dependencies MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, g++-7]
    - stage: dependencies
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=coverage
      script: TASK=dependencies MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, lcov]
    - stage: dependencies
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=coverity
      script: TASK=dependencies MAKE_PARALLEL=-j1 source .ci/build.sh
    - stage: dependencies
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=sonar
      script: TASK=dependencies MAKE_PARALLEL=-j1 source .ci/build.sh
    - stage: dependencies
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=pycarl
      script: TASK=dependencies MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, python3]
    - stage: dependencies
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=addons
      script: TASK=dependencies MAKE_PARALLEL=-j1 source .ci/build.sh
    - stage: build
      os: linux
      compiler: clang++-3.6
      env: CC=clang-3.6 CXX=clang++-3.6
      script: source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base, llvm-toolchain-precise-3.6]
          packages: [*packages_base, clang-3.6]
    - stage: build
      os: linux
      compiler: clang++-3.7
      env: CC=clang-3.7 CXX=clang++-3.7
      script: source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base, llvm-toolchain-precise-3.7]
          packages: [*packages_base, clang-3.7]
    - stage: build
      os: linux
      compiler: clang++-3.8
      env: CC=clang-3.8 CXX=clang++-3.8
      script: source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base, llvm-toolchain-precise-3.8]
          packages: [*packages_base, clang-3.8]
    - stage: build
      os: linux
      compiler: clang++-3.9
      env: CC=clang-3.9 CXX=clang++-3.9
      script: source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base, llvm-toolchain-trusty-3.9]
          packages: [*packages_base, clang-3.9]
    - stage: build
      os: linux
      compiler: clang++-4.0
      env: CC=clang-4.0 CXX=clang++-4.0
      script: source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base, llvm-toolchain-trusty-4.0]
          packages: [*packages_base, clang-4.0]
    - stage: build
      os: linux
      compiler: clang++-5.0
      env: CC=clang-5.0 CXX=clang++-5.0
      script: source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base, llvm-toolchain-trusty-5.0]
          packages: [*packages_base, clang-5.0]
    - stage: build
      os: linux
      compiler: clang++-6.0
      env: CC=clang-6.0 CXX=clang++-6.0
      script: source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base, llvm-toolchain-trusty]
          packages: [*packages_base, clang-6.0]
    - stage: build
      os: linux
      compiler: g++-5
      env: CC=gcc-5 CXX=g++-5
      script: MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, g++-5]
    - stage: build
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6
      script: MAKE_PARALLEL=-j1 source .ci/build.sh
    - stage: build
      os: linux
      compiler: g++-7
      env: CC=gcc-7 CXX=g++-7
      script: MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, g++-7]
    - stage: build
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=coverage
      script: MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, lcov]
    - stage: build
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=coverity
      script: echo "Skip"
      addons:
        apt: *apt_base
        coverity_scan:
          project:
            name: "smtrat/carl"
            description: "CArL"
          notification_email: gereon.kremer@cs.rwth-aachen.de
          build_command_prepend: cov-configure --comptype gcc --compiler `which $CXX`
          build_command: .ci/build.sh MAKE_PARALLEL=-j1
          branch_pattern: master
    - stage: build
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=sonar
      script: MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt: *apt_base
        sonarcloud:
          organization: smtrat-github
          token:
            secure: "hmFc0MVQCd9WXs08gEFZZm2YvQjRXkP8vArH2Ik3dlJSgvJkEzmi0JFrcIpzo/sRLNFd17KyB6RIT84Zd9jJzmOp5VCLmwXnwYOGXwMooIPTvCSn5qcTGrOxMxSsRUXw3nnBTHRp7D4eeUSSUMntd5EsDTRT+Par2AzGR97z2f08NdwzjWCKkAXPPtpi0lO4ZhrZSw1lYl0SqZlz5sKNKtUHHnF7mQUeimx9lmntj+clPRKceWNs9tybdzBM45bTW9/Ak+hOJVXE68iRwaTwC4MNuNJdVh7uu2F6joDuvekGk3DpzN0xqSfKd42Th7+2g5O/en9ZTfAoqhXxXY7itINdfDP4nQI1an5Kc3HF4s/s+El8KK5AAzh7PWZ25CghA80qHNearnBjGAmVJhgpNqK8Wj1W2CMKLS4BzB533RzkxQsSKDR/KlLtHq2mqrgrI3JJ/tEXRyrdMiM6CUQMAVu9jQlnEdCxtOZ746V+F1zWmtG2aDs0/V5j59D5gzyDtPQRjDf7iOnR5GcGOXERLu1EZGb23/eIX+MUgxP/9RxpfkGquOrlRwwUOBOXRxIj1dlfIbg5i2lljk9ZlDIo/FsFYMgXKh/dHVOARC/LVUkCnm4SSmeVDQIoJDUoVg7OGMHeK4ygUqgL/ocfaMh72awl6pC6SebRtZzmX8fv6P4="
    - stage: build
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=doxygen
      script: MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, doxygen, texinfo, texlive]
    - stage: build
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=pycarl
      script: MAKE_PARALLEL=-j1 source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base]
          packages: [*packages_base, python3]
    - stage: build
      os: linux
      compiler: g++-6
      env: CC=gcc-6 CXX=g++-6 TASK=addons
      script: MAKE_PARALLEL=-j1 source .ci/build.sh
    - stage: build
      os: linux
      compiler: clang++-5.0
      env: CC=clang-5.0 CXX=clang++-5.0 TASK=tidy
      script: source .ci/build.sh
      addons:
        apt:
          sources: [*sources_base, llvm-toolchain-trusty-5.0]
          packages: [*packages_base, clang-5.0]
    - stage: build
      os: osx
      osx_image: xcode7.3
      script: source .ci/build.sh
    - stage: build
      os: osx
      osx_image: xcode8.2
      script: source .ci/build.sh
    - stage: build
      os: osx
      osx_image: xcode8.3
      script: source .ci/build.sh
  allow_failures:
    - stage: dependencies
      os: linux
      env: CC=gcc-6 CXX=g++-6 TASK=coverage
    - stage: dependencies
      os: linux
      env: CC=gcc-6 CXX=g++-6 TASK=pycarl
    - stage: dependencies
      os: linux
      env: CC=gcc-6 CXX=g++-6 TASK=addons
    - stage: build
      os: linux
      env: CC=gcc-6 CXX=g++-6 TASK=coverage
    - stage: build
      os: linux
      env: CC=gcc-6 CXX=g++-6 TASK=pycarl
    - stage: build
      os: linux
      env: CC=gcc-6 CXX=g++-6 TASK=addons
    - stage: build
      os: linux
      env: CC=clang-5.0 CXX=clang++-5.0 TASK=tidy

before_install:
  - cd .ci/ && source setup_travis.sh && cd ../

notifications:
  email:
    on_failure: always
    on_success: change
  irc:
    channels:
      - "chat.freenode.net#carl"
    template:
      - "Commit to %{repository_name}/%{branch} from %{author}"
      - "%{commit_message}"
      - "Build: %{message} %{duration} %{build_url}"
  slack:
    rooms:
      secure: eEyvqmcbM8Lwi1GJLXl/W1s+r9u/GHjsOjpawLE59jj553z3MWMAdOXnwnJfjRLiHQ8mWClFYK7wknwBOknWoIKAMe3nCYEtHMOaKLUQbxxeC8fWieQx1hivRXcJ8nH9o3gSDgc2YO5+1xfM9Eynsyf/geu+0UaWc2wHFModlQfkSIHO3gErVXqfdbrLvLUKeS3DAwOPIFBpok0L3wN4h+wlPmTE7rkVH9qgi377EzCVup+aMk8jj+sduhGVIjc81qPLmR1WxGNLSwGFY2UcVNaaWVZJ1tZZ/0IFxnUKtea0cmzaRtW5mfgQ2FsiR+ZIuWu09Rub9fEiShKqyj3YOXHJs1lNl731wIUAskDERCr/+tXQoF54fkQj9xBkyIAiZlceQ9CRHAvFD4dU+tfhZeYfOVWNf9hsUkdMo/c6ZcrQq7FTektKs8JT6Wx3lTxoWBaDhjsSaGMhNlaR7tx6myIIhAbNwQh5GgY6rKawDUq0hzg8O2MM3LxHNN8p7EbpOZZHWCjrx6ATTIMFD8MgfakpcExGjz4Qy+hQApIqE7C1zOmnTXEVtCkxP6TAQPwQHFwcdUKh7PXTu531nQXvulcVd3IHup1KsiLR6l4f3xxJqh57E/7gK9bLyxvIP75h7QzuJ9WQSKU+FOgt0vYO5b/Td8I0R+wL/tWzqWdhkfQ=
